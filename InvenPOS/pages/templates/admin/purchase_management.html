{% extends 'navigation/navbar.html' %}
{% load static %}

{% block title %}Purchase Management{% endblock %}
{% block content %}
<div class="products-container">
  <div class="page-header d-flex align-items-center justify-content-between">
    <h1 class="page-title">Purchase Management</h1>

    <!-- Add Purchase Order Button that triggers modal -->
    

     <div class="d-flex gap-2">
     {% if user.is_staff %}
    <button type="button" class="btn-primary" data-bs-toggle="modal" data-bs-target="#createPurchaseModal">
      
        <i class="bi bi-plus-lg"></i>
      Add Purchase Order
    </button>
    {% endif %}

 <a href="{% url 'pages:purchase_reports' %}" class="btn-primary">
  
        <i class="bi bi-bar-chart"></i>
    Purchase Reports
</a>
    </div>
  </div>

 

  <!-- Search & Filters Bar -->
  <div class="controls-bar">
    <form method="GET" action="{% url 'pages:purchase_management' %}" class="filters-form">
      <div class="search-wrapper">
        <i class="bi bi-search"></i>
        <input type="text" name="q" placeholder="Search by Purchase ID or Supplier..." value="{{ request.GET.q }}">
      </div>

      <div class="filter-group">
        <select name="supplier" class="filter-select">
          <option value="">All Suppliers</option>
          {% for supplier in suppliers %}
          <option value="{{ supplier.name }}" {% if request.GET.supplier == supplier.name %}selected{% endif %}>
            {{ supplier.name }}
          </option>
          {% endfor %}
        </select>

        <select name="status" class="filter-select">
          <option value="">All Status</option>
          <option value="Pending" {% if request.GET.status == 'Pending' %}selected{% endif %}>Pending</option>
          <option value="Received" {% if request.GET.status == 'Received' %}selected{% endif %}>Received</option>
          <option value="Cancelled" {% if request.GET.status == 'Cancelled' %}selected{% endif %}>Cancelled</option>
        </select>

        <select name="date_order" class="filter-select">
          <option value="">Sort by Date</option>
          <option value="asc" {% if request.GET.date_order == 'asc' %}selected{% endif %}>Oldest to Newest</option>
          <option value="desc" {% if request.GET.date_order == 'desc' %}selected{% endif %}>Newest to Oldest</option>
        </select>

        <button type="submit" class="btn btn-filter">Apply</button>
      
      </div>
    </form>
  </div>

  <!-- Purchase Orders Table -->
  <div class="table-wrapper">
    <table class="sales-table">
      <thead>
        <tr>
          <th>Purchase Id</th>
          <th>Supplier</th>
          <th>Date Ordered</th>
          <th>Expected Delivery</th>
          <th>Products & Quantities</th>
          <th>Status</th>
          <th>Total Cost</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="purchaseOrdersTable">
        {% for po in purchase_orders %}
        <tr>
          <td>{{ po.id }}</td>
          <td>{{ po.supplier_name }}</td>
          <td>{{ po.date_created|date:"M d, Y" }}</td>
          <td>{{ po.expected_date|date:"M d, Y" }}</td>
          <td>
            <div class="products-list">
              {% for item in po.purchaseitem_set.all %}
                <div class="product-item">
                  <span class="product-name">{{ item.product_name }}</span>
                  <span class="quantity-badge">x{{ item.quantity }}</span>
                  <small class="text-muted">@ â‚±{{ item.cost_per_unit|floatformat:2 }}</small>
                </div>
              {% empty %}
                <span class="text-muted">No items</span>
              {% endfor %}
            </div>
          </td>
          <td>
            {% if po.status == 'Pending' %}
              <span class="badge bg-warning">Pending</span>
            {% elif po.status == 'Received' %}
              <span class="badge bg-success">Received</span>
            {% elif po.status == 'Cancelled' %}
              <span class="badge bg-danger">Cancelled</span>
            {% else %}
              <span class="badge bg-secondary">{{ po.status }}</span>
            {% endif %}
          </td>
          <td>â‚±{{ po.total_cost|floatformat:2 }}</td>
<td>
  <div class="action-buttons">
  {% if user.is_staff %}
    <button type="button" class="btn-action btn-view" data-bs-toggle="modal" data-bs-target="#purchaseDetailModal{{ po.id }}">
      View
    </button>
    {% if po.status == 'Pending' %}
      <a href="{% url 'pages:mark_received' po.id %}" class="btn-action btn-success">Mark as Received</a>
      <a href="{% url 'pages:cancel_purchase' po.id %}" class="btn-action btn-delete" onclick="return confirm('Are you sure you want to cancel this purchase order?')">Cancel Order</a>
    {% endif %}
  {% else %}
    {% if po.status == 'Received' %}
      <button type="button" class="btn-action btn-view" data-bs-toggle="modal" data-bs-target="#purchaseDetailModal{{ po.id }}">
        View
      </button>
    {% endif %}
  {% endif %}
  </div>
</td>

<!-- Include the modal for this purchase order -->
{% include 'modals/purchase_detail_modal.html' with po=po items=po.purchaseitem_set.all %}
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="text-center text-muted">No purchase records found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>


<!-- ADD PRODUCT MODAL -->
{% include 'modals/add_purchase_modal.html' %}


<script>
function addRow() {
  const table = document.getElementById('productTable');
  const rowCount = table.querySelectorAll('.product-row').length;
  
  const row = document.createElement('tr');
  row.className = 'product-row';
  row.innerHTML = `
    <td>
      <select name="product[]" class="form-control product-select" required>
        <option value="">-- Select Product --</option>
        {% for product in products %}
          <option value="{{ product.id }}">{{ product.product_name }}</option>
        {% endfor %}
      </select>
    </td>
    <td><input type="number" name="quantity[]" class="form-control quantity" min="1" required></td>
    <td><input type="number" name="cost[]" class="form-control cost" step="0.01" min="0" required></td>
    <td><button type="button" class="btn btn-sm btn-delete remove-row">Remove</button></td>
  `;
  table.appendChild(row);

  // Enable remove buttons if there's more than one row
  updateRemoveButtons();
  
  // Update scrollable behavior
  updateTableScroll();
}

function updateRemoveButtons() {
  const rows = document.querySelectorAll('.product-row');
  const removeButtons = document.querySelectorAll('.remove-row');
  
  if (rows.length > 1) {
    removeButtons.forEach(btn => btn.disabled = false);
  } else {
    removeButtons.forEach(btn => btn.disabled = true);
  }
}

function updateTableScroll() {
  const tableContainer = document.querySelector('.scrollable-table');
  const rows = document.querySelectorAll('.product-row');
  
  // Enable scrolling when there are more than 3 products
  if (rows.length > 3) {
    tableContainer.classList.add('scrollable-active');
  } else {
    tableContainer.classList.remove('scrollable-active');
  }
}

// Remove row functionality
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('remove-row')) {
    const row = e.target.closest('.product-row');
    if (document.querySelectorAll('.product-row').length > 1) {
      row.remove();
      updateRemoveButtons();
      updateTableScroll();
    }
  }
});

// AJAX form submission
document.getElementById('purchaseOrderForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const submitBtn = document.getElementById('submitBtn');
  const submitText = document.getElementById('submitText');
  const submitSpinner = document.getElementById('submitSpinner');
  const formMessage = document.getElementById('formMessage');
  
  // Show loading state
  submitBtn.disabled = true;
  submitText.textContent = 'Saving...';
  submitSpinner.classList.remove('d-none');
  formMessage.classList.add('d-none');
  
  // Collect form data
  const formData = new FormData(this);
  
  // Send AJAX request
  fetch('{% url "pages:create_purchase_order" %}', {
    method: 'POST',
    body: formData,
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Show success message
      formMessage.textContent = data.message;
      formMessage.className = 'alert alert-success';
      formMessage.classList.remove('d-none');
      
      // Reset form
      this.reset();
      
      // Remove additional rows, keep only one
      const rows = document.querySelectorAll('.product-row');
      for (let i = 1; i < rows.length; i++) {
        rows[i].remove();
      }
      updateRemoveButtons();
      updateTableScroll();
      
      // Close modal and refresh page after success
      setTimeout(() => {
        const modal = bootstrap.Modal.getInstance(document.getElementById('createPurchaseModal'));
        modal.hide();
        location.reload();
      }, 1500);
      
    } else {
      throw new Error(data.message || 'An error occurred');
    }
  })
  .catch(error => {
    formMessage.textContent = error.message;
    formMessage.className = 'alert alert-danger';
    formMessage.classList.remove('d-none');
  })
  .finally(() => {
    // Reset button state
    submitBtn.disabled = false;
    submitText.textContent = 'Save Purchase Order';
    submitSpinner.classList.add('d-none');
  });
});

// Initialize remove buttons state and table scroll
updateRemoveButtons();
updateTableScroll();

// Reset form when modal is closed
document.getElementById('createPurchaseModal').addEventListener('hidden.bs.modal', function () {
  const form = document.getElementById('purchaseOrderForm');
  form.reset();
  
  // Remove additional rows, keep only one
  const rows = document.querySelectorAll('.product-row');
  for (let i = 1; i < rows.length; i++) {
    rows[i].remove();
  }
  updateRemoveButtons();
  updateTableScroll();
  
  // Clear any messages
  const formMessage = document.getElementById('formMessage');
  formMessage.classList.add('d-none');
});
</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<style>
.product-item { 
    display: flex;
    align-items: center;
    padding: 2px 0;
    border-bottom: 1px solid var(--accent-green-light);
    margin: 0;
    line-height: 1.2;
}
.product-item:last-child {
    border-bottom: none;
}

.product-name {
    flex: 1;
    font-weight: 500;
    font-size: var(--fs-base);
    margin: 0;
}

.quantity-badge {
    color: var(--text-secondary);
    padding: 2px 6px;
    font-size: var(--fs-sm);
    margin: 0 8px;
}

.products-list {
    text-align: left;
    max-width: 250px;
    margin: 0;
    padding: 0;
}

.badge {
    font-size: var(--fs-sm);
    font-weight: var(--fw-medium);
    padding: 6px 14px;
    border-radius: 8px;
    text-transform: none;
}

/* Status badge colors */
.badge.bg-success {
    background-color: #4b8e5f !important;
}

.badge.bg-warning {
    border: 1px solid var(--accent-green);
    color: var(--accent-green);
    background-color: transparent !important;
}

.badge.bg-danger {
    background-color: #e5534b !important;
    color: white;
}

.badge.bg-secondary {
    border-radius: 8px;
    border: 1px solid var(--accent-green);
    color: var(--accent-green);
    background-color: transparent;
}

/* Action Buttons */
.btn-outline-primary{
    background: transparent;
    color: var(--accent-green);
    border: 1px solid var(--accent-green);
}

.btn-outline-secondary {
    background: transparent;
    color: var(--text-secondary);
    border: 1px solid var(--text-secondary);
    padding: 0.5rem 1rem;
    border-radius: 8px;
    text-decoration: none;
    font-size: var(--fs-sm);
    transition: all 0.2s ease;
}

.btn-outline-secondary:hover {
    background: var(--text-secondary);
    color: var(--primary-bg);
}

.btn-danger {
    background: var(--danger);
    color: var(--primary-bg);
}

.btn-success {
    background: var(--accent-green);
    color: var(--primary-bg);
}

.btn-success:hover {
    background: var(--accent-green-dark);
    transform: translateY(-1px);
}

.btn-view {
    background: var(--text-secondary);
    color: var(--primary-bg);
    max-width: 66px;
}

.btn-view:hover {
    background: var(--text-primary);
    transform: translateY(-1px);
}


/* Scrollable Table Styles */
.scrollable-table {
    max-height: 200px;
    overflow: auto;
    transition: max-height 0.3s ease;
}

.scrollable-table.scrollable-active {
    max-height: 200px;
    overflow-y: auto;
}

/* Scrollbar styling */
.scrollable-table::-webkit-scrollbar {
    width: 8px;
}

.scrollable-table::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.scrollable-table::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 10px;
}

.scrollable-table::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* Modal Styling */
    
.modal-body hr {
    margin: 1.5rem 0;
    border-color: var(--border);
}

/* Filters */
.filters-form {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
}

.search-wrapper {
    position: relative;
}

.search-wrapper i {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
}

.search-wrapper input {
    padding-left: 2rem;
}

.filter-select {
    padding: 6px 10px;
    border-radius: 6px;
    border: 1px solid var(--accent-green-light);
    max-height: 40px;
}

.btn-filter {
    background-color: var(--accent-green);
    color: var(--primary-bg);
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: var(--fs-sm);
    transition: background-color 0.3s ease;
}

.btn-filter:hover {
    background-color: var(--accent-green-dark);
    color: var(--primary-bg);
}

.controls-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 10px;
}

.filters-form {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
    width: 100%;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

.filter-select,
.btn-filter {
    height: 38px;
    border-radius: 8px;
}

/* ðŸ“± Mobile-friendly adjustments */
@media (max-width: 768px) {
    .products-list {
        max-width: 150px;
    }
    
    .product-item {
        flex-direction: column;
        align-items: flex-start;
        padding: 1px 0;
    }
    
    .quantity-badge {
        margin: 1px 0;
    }

    .filters-form {
        flex-direction: column;
        align-items: stretch;
    }

    .filter-group {
        flex-direction: column;
        align-items: stretch;
        justify-content: stretch;
        width: 100%;
    }

    .filter-select,
    .btn-filter {
        width: 100%;
    }
    
    .search-wrapper {
        min-width: 100%;
    }
    
    .modal-dialog {
        margin: 1rem;
    }
    
    .scrollable-table {
        max-height: 150px;
    }
    
    .scrollable-table.scrollable-active {
        max-height: 150px;
    }
    
    .btn-action {
        display: block;
        width: 100%;
        margin: 5px 0;
    }
}
</style>

<!-- Bootstrap JS for Modal -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}